<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
<title>修改激活</title>
<link rel="stylesheet" href="../resources/weui-1.0.2/dist/style/weui.css">

<script type="text/javascript" src="../resources/assets/js/jquery-2.0.3.min.js"></script>
<script type="text/javascript" src="../resources/weui-1.0.2/js/weui.min.js"></script>
<script type="text/javascript" src="../resources/js/jweixin-1.1.0.js"></script>
<script type="text/javascript" src="../resources/js/date.js"></script>

<style>
body {
	background: RGB(245, 245, 245)
}

.weui-cell:before {
	left: 0px;
}

#cilckbut {
	margin-top: 10%;
	width: 90%;
	margin-left: 5%;
	background: #00953e;
	font-size: 16px;
}

#act_order {
	width: 90%;
	margin-left: 5%;
	background: #00953e;
	font-size: 16px;
	margin-top: 10px
}

#picsty {
	width: 100%;
}

#pic {
	line-height: 0px;
}

.weui-cells {
	margin-top: 0px;
}

.numberleft {
	width: 75%;
	float: left;
	font-size: 16px;
	background: #00953e;
	text-align: center;
	margin-right: 10px;
	color: white;
	line-height: 40px;
	border-radius: 5px
}

.numberright {
	width: 24%;
	float: left;
	margin-top: 0px;
	font-size: 15px;
	background: #00953e;
	text-align: center;
	color: white;
	line-height: 40px;
	border-radius: 5px;
}

#picturesty {
	width: 50px;
	height: 50px;
	margin-left: 45%;
	margin-top: 100px
}

#bodysection {
	display: none;
}
</style>
</head>
<body ontouchstart>
<!--	<img src="../resources/images/load.gif" id="picturesty">-->
	<div id="bodysection">
		<div id="pic"></div>
		<div class="weui-cells">
			<div class="weui-cell" style="background: RGB(245, 245, 245);">国家</div>

			<div class="weui-cell weui-cell_select">
				<div class="weui-cell__bd">
					<select class="weui-select" id="country_name" onchange="initCountry()">
					</select>
				</div>
			</div>

			<div class="weui-cell" style="background: RGB(245, 245, 245)">
				<div id="scanQRCode" class="numberleft"></div>
				<div class="numberright" onclick="hand_input()">手动输入</div>
			</div>

			<div id="card" class="weui-cells" style="background: RGB(245, 245, 245);"></div>

			<div class="weui-cell" style="background: RGB(245, 245, 245);">开卡日期</div>

			<div class="weui-cell">
				<div class="weui-cell__bd">
					<input id="in" class="weui-input" type="text" readonly="readonly" onclick="sertime()" unselectable="on" onfocus="this.blur()">
				</div>
			</div>
		</div>
		<a class="weui-btn weui-btn_warn" id="cilckbut" onclick="submit_inf()">提交激活信息</a> <a class="weui-btn weui-btn_warn" id="act_order" onclick="check_record()">查看激活记录</a>
	</div>
	<div class="js_dialog" id="dialog" style="display: none;">
		<div class="weui-mask"></div>
		<div class="weui-dialog">
			<div class="weui-dialog__hd">
				<strong class="weui-dialog__title">手动输入</strong>
			</div>
			<div class="weui-cells weui-cells_form">
				<div class="weui-cell">
					<div class="weui-cell__bd">
						<input class="weui-input" type="text" id="code">
					</div>
				</div>
			</div>
			<div class="weui-dialog__ft">
				<a class="weui-dialog__btn weui-dialog__btn_default" onclick="cancel()">取消</a> <a class="weui-dialog__btn weui-dialog__btn_primary" onclick="submit()">确定</a>
			</div>
		</div>
	</div>
	<script type="text/javascript">
	function getQueryString(str) {
		var reg = new RegExp("(^|&)" + str + "=([^&]*)(&|$)", "i");
		var r = window.location.search.substr(1).match(reg);
		if (r != null)
			return unescape(r[2]);
		return null;
	}

	var openId = null;
	var businessId = getQueryString("businessId");
	var code = getQueryString("code");
	var countryID = getQueryString("countryId");
	$.post("../center/activation", {
		businessId : businessId,
		code : code,
		countryId : countryID
	}, function(res) {
		if (res.success) {
			openId = res.data.openId;
			for (var i = 0; i < res.data.countryList.length; i++) {
				var country = res.data.countryList[i];
				var str = "<option value='" + country.countryId 
		                + "' id='" + country.countryId 
		                + "' length='" + country.cardNoLength 
		                + "' name='" + country.cardNoName 
		                + "' img='" + country.imgurl 
		                + "' barCodeLength='" + country.barCodeLength 
		                + "' activateDatePrompt='" + country.activateDatePrompt 
		                + "' activateDateEarliest='" + country.activateDateEarliest + "'>"
				        + country.countryName + "</option>"
		        $("#country_name").append(str);
			}
			$("#country_name").find("option[value = '" + countryID + "']").attr("selected", "selected");
			$("#picturesty").css('display', 'none');
			$("#bodysection").css('display', 'block');
			initCountry();
			var jssdk = res.data.jssdk;
			var dataObj = eval(jssdk);
			var options = {
				debug : false,
				jsApiList : [ "scanQRCode" ]
			};
			$.extend(options, dataObj);
			wx.config(options);
			wx.ready(function() {
				$("#scanQRCode").click(function() {
					var country = $("#country_name").val();
					if (!country) {
						alert("请选择国家");
						return;
					}
					var countryId = $("#" + country).val();
					wx.scanQRCode({
						needResult : 1,
						desc : 'scanQRCode desc',
						success : function(res) {
							var result = res.resultStr;
							var barCode = "";
							if (result.indexOf(",") >= 0) {
								var tempArray = result.split(',');
								var tempNum = tempArray[1];
								barCode = tempNum;
							} else {
								barCode = result;
							}
							if (!validateCodeLength(country, barCode)) {
								alert("无效的条形码");
								return;
							}
							$.post("../center/checkBarCode", {
								barCode : barCode,
								countryId : countryId
							}, function(r) {
								if (r.success) {
									var cardNo = r.data.cardNo;
									$("#cardNo").val(cardNo);
								} else {
									alert(r.desc);
								}
							}, 'json');
						}
					});
				});
			});
		} else if (res.code == 2) {
			window.location.href = res.desc;
		} else {
			window.location.href = "not-exist.html";
		}
	})

	function initCountry() {
		var country = $("#country_name").val();
		var cardNoName = $("#" + country).attr("name");
		var imgurl = $("#" + country).attr("img");
		var activateDatePrompt = $("#" + country).attr("activateDatePrompt");
		$("#pic").html("<img src='" + imgurl + "' id='picsty'>");
		$("#card").empty();
		$("#card").append("<div class='weui-cell'>" + cardNoName + "</div>");
		$("#card").append("<div class='weui-cell'><div class='weui-cell__bd'><input class='weui-input' disabled='disabled' type='text' id='cardNo' placeholder='请输入" + cardNoName + "'></div></div>");
		$("#scanQRCode").html("扫码获取" + cardNoName);
		$("#code").attr("placeholder", "手动输入获取" + cardNoName);
		$("#in").attr("placeholder", "请选择激活日期（" + activateDatePrompt + "）");
	}

	function validateCodeLength(country, code) {
		var cardLength = $("#" + country).attr("length");
		var barCodeLength = $("#" + country).attr("barCodeLength");
		var length = cardLength.split(",");
		var length2 = barCodeLength.split(",");
		if ($.inArray(code.length.toString(), length) == -1 && $.inArray(code.length.toString(), length2) == -1 && code.length != 13) {
			return false;
		} else {
			return true;
		}
	}

	function hand_input() {
		var country = $("#country_name").val();
		if (country) {
			var cardNoName = $("#" + country).attr("name");
			$("#code").attr("placeholder", "手动输入获取" + cardNoName);
			$("#dialog").css("display", "block");
		} else {
			alert("请选择国家");
		}
	}

	function submit() {
		var code = $("#code").val();
		if (!code) {
			alert("不能为空");
			return;
		}
		var country = $("#country_name").val();
		var countryId = $("#" + country).val();
		if (!validateCodeLength(country, code)) {
			alert("输入错误");
			return;
		}
		$.post("../center/checkBarCode", {
			barCode : code,
			countryId : countryId
		}, function(r) {
			if (r.success) {
				var cardNo = r.data.cardNo;
				$("#cardNo").val(cardNo);
				$("#dialog").css("display", "none");
			} else {
				alert("输入错误");
			}
		}, 'json');
	}

	function cancel() {
		$("#dialog").css("display", "none");
	}

	function sertime() {
		var country = $("#country_name").val();
		var firstDay = getDate($("#" + country).attr("activateDateEarliest"));
		weui.datePicker({
			start : firstDay, // 从今天开始
			end : 2030,
			defaultValue : [ firstDay.getFullYear(), firstDay.getMonth() + 1, firstDay.getDate() ],
			onConfirm : function(result) {
				var x = result[0].value + "-" + (result[1].value < 10 ? ('0' + result[1].value) : result[1].value) + "-" + (result[2].value < 10 ? ('0' + result[2].value) : result[2].value);
				$("#in").val(x);
			},
			id : 'datePicker'
		});
	}

	function submit_inf() {
		var country = $("#country_name").val();
		if (!country) {
			alert("请选择国家");
			return;
		}
		var countryId = $("#" + country).val();
		var cardNoName = $("#" + country).attr("name");
		var cardNo = $("#cardNo").val().trim();
		if (!cardNo) {
			alert("请获取" + cardNoName);
			return;
		}
		var sec_date = $("#in").val();
		if (!sec_date) {
			alert("请选择开卡日期");
			return;
		}
		weui.loading('loading');
		$.post("../center/saveActivation", {
			openId : openId,
			countryId : countryId,
			cardNo : cardNo,
			businessId : businessId,
			appointmentTime : sec_date
		}, function(r) {
			if (r.success) {
				var type = r.data.type;
				weui.loading('loading').hide();
				window.location.href = "saveActivatonSuccess.html?openId=" + openId + "&businessId=" + businessId + "&sec_date=" + sec_date + "&type=" + type;
			} else {
				weui.loading('loading').hide();
				alert(r.desc)
			}
		}, 'json');
	}

	function check_record() {
		window.location.href = "activationRecord.html?openId=" + openId + "&businessId=" + businessId;
	}
</script>
</body>
</html>